name: deploy
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [ master ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read
  
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout code'
        uses: actions/checkout@v4
        
      - name: 'Setup .NET'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          
      - name: 'Restore dependencies'
        run: dotnet restore
          
      - name: 'Build Solution'
        run: dotnet build --no-restore

      - name: 'Run All Tests'
        run: dotnet test --no-build --verbosity normal
  
  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: 'Checkout code'
        uses: actions/checkout@v4

      - name: 'Login to Azure'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      # Before deploying apps to Azure, we need to deploy the foundation resources first to create ACR    
      - name: 'Deploy Foundation'
        id: foundation_deploy
        uses: azure/arm-deploy@v2
        with:
          resourceGroupName: ${{ secrets.AZURE_RG }}
          template: ./infra/modules/foundation.bicep
          parameters: > 
            prefix=jobsearch 
            location=northeurope
      
      # Build the scraper image to ACR to pass it to Bicep
      - name: 'Build Scraper Image in ACR'
        id: build_image
        run: |
          # Get the ACR name from the Foundation deployment outputs
          ACR_NAME=${{ steps.foundation_deploy.outputs.containerRegistryName }}
          IMAGE_TAG="scraper:${{ github.sha }}"
          
          # Specify the path to the Scraper's Dockerfile
          az acr build --registry $ACR_NAME --image $IMAGE_TAG --file JobSearch.DataScraper/Dockerfile .
          
          # Save the full image path for the next Bicep step
          echo "full_image=$ACR_NAME.azurecr.io/$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: 'Deploy Bicep'
        id: bicep_deploy
        uses: azure/arm-deploy@v2
        with:
          resourceGroupName: ${{ secrets.AZURE_RG }}
          template: ./infra/main.bicep
          parameters: >
            prefix=jobsearch
            dbPassword=${{ secrets.AZURE_DB_PASSWORD }}
            location=northeurope
            scraperImage=${{ steps.build_image.outputs.full_image }}
            
      #- name: 'Wait for PostgreSQL server to be ready'
      #  run: |
      #    echo "Waiting 2 minutes for PostgreSQL server to complete provisioning..."
      #    sleep 120
      #      
      #- name: 'Create PostgreSQL firewall rule for Azure services'
      #  run: |
      #    SERVER_NAME="${{ steps.bicep_deploy.outputs.storageServerName }}"
#
      #    echo "Creating firewall rule for server: $SERVER_NAME"
      #    az postgres flexible-server firewall-rule create \
      #      --resource-group ${{ secrets.AZURE_RG }} \
      #      --name $SERVER_NAME \
      #      --rule-name AllowAzureServices \
      #      --start-ip-address 0.0.0.0 \
      #      --end-ip-address 0.0.0.0
#
      #    echo "Firewall rule created successfully"
      #    
      #- name: 'Update Azure Key Vault Secrets'
      #  run: |
      #    KV_NAME=${{ steps.bicep_deploy.outputs.keyVaultName }}
      #    az keyvault secret set --vault-name "$KV_NAME" --name "usa-jobs-api-key" --value "${{ secrets.USA_JOBS_API_KEY }}"
      #    az keyvault secret set --vault-name "$KV_NAME" --name "db-password" --value "${{ secrets.AZURE_DB_PASSWORD }}"
      
     #       
     # - name: 'Wait for Identity sync'
     #   run: sleep 60
#
     # - name: 'Build and push real images'
     #   run: |
     #     ACR_NAME=${{ steps.bicep_deploy.outputs.containerRegistryName }}
     #     az acr build --registry $ACR_NAME --image jobapi:${{ github.sha }} ./JobSearch.Api
     #     az acr build --registry $ACR_NAME --image datascraper:${{ github.sha }} ./JobSearch.DataScraper
#
     # - name: '5Update Scraper with real image'
     #   run: |
     #     ACR_NAME=${{ steps.bicep_deploy.outputs.containerRegistryName }}
     #     az containerapp job update -n scraper -g ${{ secrets.AZURE_RG }} --image $ACR_NAME.azurecr.io/datascraper:${{ github.sha }}
#
     # - name: '5Update API with real image'
     #   run: |
     #     ACR_NAME=${{ steps.bicep_deploy.outputs.containerRegistryName }}
     #     az containerapp update -n api -g ${{ secrets.AZURE_RG }} --image $ACR_NAME.azurecr.io/jobapi:${{ github.sha }}
#
     # - name: 'Update Azure Key Vault Secrets'
     #   run: |
     #     KV_NAME=${{ steps.bicep_deploy.outputs.keyVaultName }}
     #     az keyvault secret set --vault-name "$KV_NAME" --name "usa-jobs-api-key" --value "${{ secrets.USA_JOBS_API_KEY }}"
     #     az keyvault secret set --vault-name "$KV_NAME" --name "db-password" --value "${{ secrets.AZURE_DB_PASSWORD }}" 