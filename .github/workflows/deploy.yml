name: deploy
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [ master ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read
  
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: '1. Checkout code'
        uses: actions/checkout@v4
        
      - name: '2. Setup .NET'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          
      - name: '3. Restore dependencies'
        run: dotnet restore
          
      - name: '4. Build Solution'
        run: dotnet build --no-restore

      - name: '5. Run All Tests'
        run: dotnet test --no-build --verbosity normal
  
  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: '1. Checkout code'
        uses: actions/checkout@v4

      - name: '2. Login to Azure'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: '3. Deploy Bicep'
        id: bicep_deploy
        uses: azure/arm-deploy@v2
        with:
          resourceGroupName: ${{ secrets.AZURE_RG }}
          template: ./infra/main.bicep
          parameters: >
            dbPassword=${{ secrets.AZURE_DB_PASSWORD }}
            location=northeurope

      - name: '4. Build and push real images'
        run: |
          ACR_NAME=${{ steps.bicep_deploy.outputs.containerRegistryName }}
          az acr build --registry $ACR_NAME --image jobapi:${{ github.sha }} ./JobSearch.Api
          az acr build --registry $ACR_NAME --image datascraper:${{ github.sha }} ./JobSearch.DataScraper

      - name: '5. Update Container App & Job with real images'
        run: |
          ACR_NAME=${{ steps.bicep_deploy.outputs.containerRegistryName }}
          az containerapp update -n api -g ${{ secrets.AZURE_RG }} --image $ACR_NAME.azurecr.io/jobapi:${{ github.sha }}
          az containerapp job update -n scraper -g ${{ secrets.AZURE_RG }} --image $ACR_NAME.azurecr.io/datascraper:${{ github.sha }}
          
      - name: '6. Update Azure Key Vault Secrets'
        run: |
          KV_NAME=${{ steps.bicep_deploy.outputs.keyVaultName }}
          az keyvault secret set --vault-name "$KV_NAME" --name "usa-jobs-api-key" --value "${{ secrets.USA_JOBS_API_KEY }}"
          az keyvault secret set --vault-name "$KV_NAME" --name "db-password" --value "${{ secrets.AZURE_DB_PASSWORD }}"
              
            